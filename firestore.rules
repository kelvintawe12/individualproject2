rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // helper functions
    function isSignedIn() { return request.auth != null; }
    function chatIsParticipant(chatId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && (get(/databases/$(database)/documents/chats/$(chatId)).data.participants has request.auth.uid);
    }

    // users collection: only the user themselves may create/update/delete their profile
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // listings: any signed-in user may read; only owner may create/update/delete their listing
    match /listings/{listingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // swaps: requester can create, requester/owner can read, owner can update (accept)
    match /swaps/{swapId} {
      allow read: if isSignedIn() && (request.auth.uid == resource.data.requesterId || request.auth.uid == resource.data.ownerId);
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.requesterId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      allow delete: if false;
    }

    // chats: participants only
    match /chats/{chatId} {
      // chat document should contain a `participants` array of uids
      allow read: if isSignedIn() && chatIsParticipant(chatId);
      // creation of a chat requires the creator to be a participant
      allow create: if isSignedIn() && request.resource.data.participants is list && request.auth.uid in request.resource.data.participants;
      // no direct updates/deletes of the chat document in this rule set (you can adjust as needed)
      allow update, delete: if false;

      // messages subcollection
      match /messages/{messageId} {
        allow read: if isSignedIn() && chatIsParticipant(chatId);
        // senderId must equal authenticated uid, and sender must be a participant
        allow create: if isSignedIn()
                     && chatIsParticipant(chatId)
                     && request.auth.uid == request.resource.data.senderId;
        // messages are immutable in this rule set
        allow update, delete: if false;
      }
    }

    // Default: deny everything else
  }
}
